{% extends 'base.html' %}
{% load static %}

{% block content %}

<div class="etapa-container">
  <h2>üçï Escolha sua Pizza</h2>

  <!-- Etapa 1: Escolha de Sabores -->
  <div class="etapa" id="etapa1">
    <p>Quantos sabores voc√™ deseja?</p>
    <div class="botoes-sabores">
      <button class="btn-sabor" onclick="escolherSabores(1)">1 Sabor</button>
      <button class="btn-sabor" onclick="escolherSabores(2)">2 Sabores</button>
    </div>
  </div>

  <!-- Etapa 2: Filtro de Pizzas -->
  <div class="etapa" id="etapa2" style="display: none;">
    <input type="text" id="campoFiltro" placeholder="üîç Buscar pizza..." onkeyup="filtrarPizzas()">
  </div>

  <!-- Etapa 3: Lista de Pizzas -->
  <div class="etapa" id="etapa3" style="display: none;">
    <div class="grade-pizzas">
      {% for pizza in pizzas %}
      <div class="card-pizza" onclick="selecionarPizza('{{ pizza.id }}', '{{ pizza.nome }}', '{{ pizza.preco }}', this)">
        <img src="{{ pizza.imagem.url }}" alt="{{ pizza.nome }}">
        <h4>{{ pizza.nome }}</h4>
        <p>{{ pizza.ingredientes }}</p>
        <span class="preco">R$ {{ pizza.preco }}</span>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Etapa 4: Resumo do Pedido -->
  <div class="etapa" id="etapa4" style="display: none;">
    <div class="resumo">
      <h3>üßæ Resumo</h3>
      <ul id="resumo-sabores"></ul>

      <div class="botoes-resumo">
        <button type="button" class="btn-finalizar" onclick="adicionarAoPedido()">‚ûï Adicionar ao Pedido</button>
        <form method="post" style="display: inline;">
          {% csrf_token %}
          <input type="hidden" name="pedido_final" id="pedido_final">
          <button type="submit" class="btn-finalizar" style="background-color: green;">Finalizar Pedido</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
let modo = 1;
let pizza1 = null;
let pizza2 = null;
let carrinho = [];

function escolherSabores(qtd) {
  modo = qtd;
  document.getElementById("etapa2").style.display = "block";
  document.getElementById("etapa3").style.display = "block";
  document.getElementById("etapa4").style.display = "block";
  pizza1 = null;
  pizza2 = null;
  atualizarResumo();
}

function filtrarPizzas() {
  const filtro = document.getElementById("campoFiltro").value.toLowerCase();
  document.querySelectorAll(".card-pizza").forEach(card => {
    card.style.display = card.innerText.toLowerCase().includes(filtro) ? "" : "none";
  });
}

function selecionarPizza(id, nome, preco, el) {
  if (modo === 1) {
    pizza1 = { id, nome, preco };
    pizza2 = null;
  } else {
    if (!pizza1 || pizza1.id === id) {
      pizza1 = { id, nome, preco };
    } else {
      pizza2 = { id, nome, preco };
    }
  }
  atualizarResumo();
  atualizarSelecaoVisual();
}

function atualizarResumo() {
  const resumo = document.getElementById("resumo-sabores");
  resumo.innerHTML = '';

  // Exibe os itens j√° adicionados ao carrinho
  carrinho.forEach((item, index) => {
    let texto = item.pizza2
      ? `üçï ${item.pizza1.nome} + ${item.pizza2.nome} ‚Äî <strong>R$ ${item.total}</strong>`
      : `üçï ${item.pizza1.nome} ‚Äî <strong>R$ ${item.total}</strong>`;

    resumo.innerHTML += `
      <li>
        ${texto}
        <button class="btn-excluir" onclick="removerDoPedido(${index})" title="Excluir item">‚ùå</button>
      </li>`;
  });

  // Exibe pizza atual em sele√ß√£o
  if (pizza1) {
    let selecionando = modo === 2 && pizza2
      ? `üçï ${pizza1.nome} + ${pizza2.nome}`
      : `üçï ${pizza1.nome}`;
    resumo.innerHTML += `<li style="color: #888;">Selecionando: ${selecionando}</li>`;
  }
}

function removerDoPedido(index) {
  carrinho.splice(index, 1);
  atualizarResumo();
}

function atualizarSelecaoVisual() {
  document.querySelectorAll('.card-pizza').forEach(card => card.classList.remove('selecionada'));
  [pizza1, pizza2].forEach(p => {
    if (p) {
      let card = document.querySelector(`[onclick*="'${p.id}'"]`);
      if (card) card.classList.add('selecionada');
    }
  });
}

function adicionarAoPedido() {
  if (!pizza1) {
    alert("Selecione pelo menos 1 sabor.");
    return;
  }

  const preco1 = parseFloat(pizza1.preco);
  const preco2 = pizza2 ? parseFloat(pizza2.preco) : 0;
  const total = modo === 2 ? Math.max(preco1, preco2) : preco1;

  carrinho.push({
    pizza1,
    pizza2,
    total: total.toFixed(2)
  });

  pizza1 = null;
  pizza2 = null;
  atualizarResumo();
  atualizarSelecaoVisual();

  // Reset para nova escolha
  document.getElementById("campoFiltro").value = "";
  filtrarPizzas();
  document.getElementById("etapa2").style.display = "none";
  document.getElementById("etapa3").style.display = "none";
}

document.querySelector("form").addEventListener("submit", function(e) {
  document.getElementById("pedido_final").value = JSON.stringify(carrinho);
});
</script>
{% endblock %}
