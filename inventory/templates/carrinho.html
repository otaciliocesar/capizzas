{% extends 'base.html' %}
{% load static %}

{% block content %}


<div class="container mt-4">

    <!-- Escolha de 1 ou 2 sabores -->
<div class="escolha-e-filtro">

  <div class="centralizar-escolha mb-4">
    <h3 class="mb-3">üçï Qual tipo de pizza voc√™ deseja?</h3>

    <div class="btn-group btn-sabores">
      <button class="btn btn-primary" onclick="definirQuantidadeSabores(1)">1 Sabor</button>
      <button class="btn btn-success" onclick="definirQuantidadeSabores(2)">2 Sabores</button>
    </div>
  </div>

  <div id="filtro-container" class="text-center" style="display:none;">
    <input type="text" id="filtro-pizza" placeholder="Buscar pizza..." class="filtro-input" onkeyup="filtrarPizzas()">
  </div>

</div>
    <!-- Layout principal -->
    <div class="row">
        <!-- Resumo do pedido -->
        <div class="col-md-4" id="resumo-container" style="display: none;">
            <div class="card p-3">
                <h4 class="mb-3">üßæ Resumo do Pedido</h4>
                <ul class="list-group mb-3">
                    <li class="list-group-item">Sabor 1: <span id="resumo-sabor1">‚Äî</span></li>
                    <li class="list-group-item">Sabor 2: <span id="resumo-sabor2">‚Äî</span></li>
                    <li class="list-group-item"><strong>Total: R$ <span id="resumo-total">0.00</span></strong></li>
                </ul>
                <form method="post">
                    {% csrf_token %}
                    {{ form.as_p }}
                    <button type="submit" class="btn btn-success w-100">Finalizar Pedido</button>
                </form>
            </div>
        </div>

        <!-- Lista de pizzas -->
        <div class="col-md-8">
            <div class="row" id="lista-pizzas" style="display: none;">
                {% for pizza in pizzas %}
                <div class="col-md-6 mb-4 pizza-item">
                    <div class="card h-100 pizza-card" onclick="selecionarPizza('{{ pizza.id }}', '{{ pizza.nome }}', '{{ pizza.preco }}', this)">
                        <img src="{{ pizza.imagem.url }}" class="card-img-top" alt="{{ pizza.nome }}">
                        <div class="card-body">
                            <h5 class="card-title">{{ pizza.nome }}</h5>
                            <p class="card-text text-muted">{{ pizza.ingredientes }}</p>
                            <p class="card-text"><strong>R$ {{ pizza.preco }}</strong></p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
let modo = 1; // 1 sabor ou 2 sabores
let pizzaSelecionada1 = null;
let pizzaSelecionada2 = null;

function definirQuantidadeSabores(qtd) {
    modo = qtd;
    document.getElementById('filtro-container').style.display = 'block';
    document.getElementById('lista-pizzas').style.display = 'flex';
    document.getElementById('resumo-container').style.display = 'block';
    resetResumo();
}

function selecionarPizza(id, nome, preco, el) {
    if (modo === 1) {
        pizzaSelecionada1 = {id, nome, preco};
        pizzaSelecionada2 = null;
    } else {
        if (!pizzaSelecionada1) {
            pizzaSelecionada1 = {id, nome, preco};
        } else if (!pizzaSelecionada2 && pizzaSelecionada1.id !== id) {
            pizzaSelecionada2 = {id, nome, preco};
        } else {
            pizzaSelecionada1 = {id, nome, preco};
            pizzaSelecionada2 = null;
        }
    }

    // Atualiza inputs hidden do form
    document.querySelector('#id_pizza_1').value = pizzaSelecionada1 ? pizzaSelecionada1.id : '';
    document.querySelector('#id_pizza_2').value = pizzaSelecionada2 ? pizzaSelecionada2.id : '';

    // Atualiza resumo
    document.getElementById('resumo-sabor1').textContent = pizzaSelecionada1 ? pizzaSelecionada1.nome : '‚Äî';
    document.getElementById('resumo-sabor2').textContent = pizzaSelecionada2 ? pizzaSelecionada2.nome : '‚Äî';

    let preco1 = pizzaSelecionada1 ? parseFloat(pizzaSelecionada1.preco) : 0;
    let preco2 = pizzaSelecionada2 ? parseFloat(pizzaSelecionada2.preco) : 0;
    let total = modo === 2 ? Math.max(preco1, preco2) : preco1;
    document.getElementById('resumo-total').textContent = total.toFixed(2);

    // Marcar visualmente
    document.querySelectorAll('.pizza-card').forEach(card => card.classList.remove('selecionada'));
    if (pizzaSelecionada1) {
        let card1 = document.querySelector(`[onclick*="'${pizzaSelecionada1.id}'"]`);
        if (card1) card1.classList.add('selecionada');
    }
    if (pizzaSelecionada2) {
        let card2 = document.querySelector(`[onclick*="'${pizzaSelecionada2.id}'"]`);
        if (card2) card2.classList.add('selecionada');
    }
}

function filtrarPizzas() {
    let filtro = document.getElementById("filtro-pizza").value.toLowerCase();
    let pizzas = document.getElementsByClassName("pizza-item");
    for (let i = 0; i < pizzas.length; i++) {
        let texto = pizzas[i].textContent || pizzas[i].innerText;
        pizzas[i].style.display = texto.toLowerCase().includes(filtro) ? "" : "none";
    }
}

function resetResumo() {
    pizzaSelecionada1 = null;
    pizzaSelecionada2 = null;
    document.getElementById('resumo-sabor1').textContent = '‚Äî';
    document.getElementById('resumo-sabor2').textContent = '‚Äî';
    document.getElementById('resumo-total').textContent = '0.00';
}
</script>
{% endblock %}
