{% extends 'base.html' %}
{% load static %}
{% load carrinho_filters %}

{% block content %}
<div class="checkout-container nota-fiscal">
  <h2>ğŸ§¾ ConfirmaÃ§Ã£o do Pedido</h2>

  <!-- DADOS DO CLIENTE -->
  <div class="dados-cliente bloco-nota">
    <h3>ğŸ‘¤ Dados do Cliente</h3>
    <p><strong>Nome:</strong> {{ request.user.first_name }} {{ request.user.last_name }}</p>
    <p><strong>Email:</strong> {{ request.user.email }}</p>
    <p><strong>EndereÃ§o:</strong> {{ request.user.cliente.endereco_entrega }}, NÂº {{ request.user.cliente.numero }}</p>
  </div>

  <!-- RESUMO DO PEDIDO -->
  <div class="resumo-pedido bloco-nota">
    <h3>ğŸ“¦ Itens do Pedido</h3>
    <table class="tabela-nota">
      <thead>
        <tr>
          <th>Item</th>
          <th>Qtd</th>
          <th>PreÃ§o</th>
        </tr>
      </thead>
      <tbody>
        {% for item in carrinho %}
        <tr>
          <td>
  {% if item.tipo == 'pizza' %}
    ğŸ•
    {% if item.pizza2 %}
      {{ item.pizza1.nome }} + {{ item.pizza2.nome }}
    {% else %}
      {{ item.pizza1.nome }}
    {% endif %}
    {% if item.borda and item.borda.nome and item.borda.nome != "Sem borda" %}
      ({{ item.borda.nome }})
    {% endif %}
  {% elif item.tipo == 'bebida' %}
    ğŸ¥¤ {{ item.bebida.nome }}
  {% endif %}
</td>
          <td>
            {% if item.tipo == 'bebida' %}
              {{ item.quantidade }}
            {% else %}
              1
            {% endif %}
          </td>
          <td>R$ {{ item.total }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <p class="total-final">
      <strong>Total:</strong> R$ {{ carrinho|calc_total }}
    </p>
  </div>

  <!-- BOTÃ•ES -->
<div class="botoes-final">
  {{ carrinho|json_script:"pedido_final_json" }}
<form method="post" action="{% url 'checkout' %}">
  {% csrf_token %}
  <input type="hidden" name="pedido_final" value="">
  <input type="hidden" name="finalizar_pedido" value="1">
  {% if promocao %}
    <input type="hidden" name="promocao_slug" value="{{ promocao.slug }}">
  {% endif %}
  <button id="btn-confirmar" class="btn-confirmar" type="button">âœ… Confirmar Pedido</button>
</form>

{% if pagseguro_url %}
  <div class="checkout-pagamento">
    <p>âœ… Pedido confirmado!</p>
    <p>Finalize o pagamento no PagSeguro:</p>
    <a href="{{ pagseguro_url }}" class="btn btn-success" target="_blank">ğŸ’³ Pagar com PagSeguro</a>
  </div>
{% endif %}

  {% if promocao %}
    <a class="btn-voltar" href="{% url 'pedido_promocao' promocao.slug %}">Refazer pedido</a>
  {% else %}
    <a class="btn-voltar" href="{% url 'carrinho' %}">Refazer pedido</a>
{% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const btnConfirmar = document.getElementById("btn-confirmar");
  btnConfirmar.addEventListener("click", () => {
    btnConfirmar.disabled = true;
    btnConfirmar.textContent = "Processando...";

    fetch("{% url 'pagamento_pagbank' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/json",
      },
      body: JSON.stringify({})
    })
    .then(res => res.json())
    .then(data => {
      if (data.pagamento_url) {
        window.location.href = data.pagamento_url;
      } else {
        alert(data.error || "Erro ao iniciar pagamento.");
        btnConfirmar.disabled = false;
        btnConfirmar.textContent = "âœ… Confirmar Pedido";
      }
    })
    .catch(() => {
      alert("Erro inesperado.");
      btnConfirmar.disabled = false;
      btnConfirmar.textContent = "âœ… Confirmar Pedido";
    });
  });
});
</script>
{% endblock %}
