{% extends 'base.html' %}
{% load static %}
{% load carrinho_filters %}

{% block content %}
<div class="checkout-container nota-fiscal">
  <h2>üßæ Confirma√ß√£o do Pedido</h2>

  <!-- DADOS DO CLIENTE -->
  <div class="dados-cliente bloco-nota">
    <h3>üë§ Dados do Cliente</h3>
    <p><strong>Nome:</strong> {{ request.user.first_name }} {{ request.user.last_name }}</p>
    <p><strong>Email:</strong> {{ request.user.email }}</p>
    <p><strong>Endere√ßo:</strong> {{ request.user.cliente.endereco_entrega }}, N¬∫ {{ request.user.cliente.numero }}</p>
  </div>

  <!-- RESUMO DO PEDIDO -->
  <div class="resumo-pedido bloco-nota">
    <h3>üì¶ Itens do Pedido</h3>
    <table class="tabela-nota">
      <thead>
        <tr>
          <th>Item</th>
          <th>Qtd</th>
          <th>Pre√ßo</th>
        </tr>
      </thead>
      <tbody>
        {% for item in carrinho %}
        <tr>
          <td>
            {% if item.tipo == 'pizza' %}
              üçï {{ item.pizza1.nome }}{% if item.pizza2 %} + {{ item.pizza2.nome }}{% endif %}
            {% elif item.tipo == 'bebida' %}
              ü•§ {{ item.bebida.nome }}
            {% endif %}
          </td>
          <td>
            {% if item.tipo == 'bebida' %}
              {{ item.quantidade }}
            {% else %}
              1
            {% endif %}
          </td>
          <td>R$ {{ item.total }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <p class="total-final">
      <strong>Total:</strong> R$ {{ carrinho|calc_total }}
    </p>
  </div>

  <!-- BOT√ïES -->
<div class="botoes-final">
  {{ carrinho|json_script:"pedido_final_json" }}
  <form method="post" action="{% url 'finalizar_pedido' %}">
    {% csrf_token %}
    <input type="hidden" name="pedido_final" value="">
    {% if promocao %}
      <input type="hidden" name="promocao_slug" value="{{ promocao.slug }}">
    {% endif %}
    <button type="submit" class="btn-confirmar">‚úÖ Confirmar Pedido</button>
  </form>

  {% if promocao %}
    <a class="btn-voltar" href="{% url 'pedido_promocao' promocao.slug %}">Voltar</a>
  {% else %}
    <a class="btn-voltar" href="{% url 'carrinho' %}">Voltar</a>
{% endif %}
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const pedido = JSON.parse(document.getElementById("pedido_final_json").textContent);
    document.querySelector('input[name="pedido_final"]').value = JSON.stringify(pedido);
  });
</script>
{% endblock %}
